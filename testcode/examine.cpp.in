#include <VolumeViz/nodes/SoVolumeRendering.h>
#include <VolumeViz/nodes/SoVolumeData.h>
#include <VolumeViz/nodes/SoVolumeRender.h>
#include <VolumeViz/nodes/SoTransferFunction.h>
#include <Inventor/Qt/SoQtRenderArea.h>
#include <Inventor/@Gui@/So@Gui@.h>
#include <Inventor/@Gui@/viewers/So@Gui@ExaminerViewer.h>
#include <Inventor/nodes/SoSeparator.h>
#include <Inventor/nodes/SoPerspectiveCamera.h>
#include <Inventor/nodes/SoDirectionalLight.h>
#include <Inventor/nodes/SoCube.h>
#include <Inventor/manips/SoTrackballManip.h>
#include <Inventor/nodes/SoDrawStyle.h>
#include <Inventor/nodes/SoLightModel.h>
#include <math.h>


void setDot(int *pData,
            int xDim, int yDim, int zDim,
            float X, float Y, float Z,
            unsigned char R,
            unsigned char G,
            unsigned char B,
            unsigned char A)
{
  int nX = int(xDim*X);
  int nY = int(yDim*Y);
  int nZ = int(zDim*Z);

  //  if (A < 128) A = 0;
  // if (A >= 128) A = 255;
  A >>= 2;

  if (R < 128) R = 0;
  if (R >= 128) R = 255;

  int pixel = (A<<24) + (B<<16) + (G<<8) + R;
  pData[nZ*xDim*yDim + nY*xDim + nX] = pixel;

  pixel = (A<<24) + (B<<16) + (G<<8) + R ;
  pData[(nZ+1)*xDim*yDim + nY*xDim + nX] = pixel;
  pData[(nZ-1)*xDim*yDim + nY*xDim + nX] = pixel;
  pData[nZ*xDim*yDim + (nY+1)*xDim + nX] = pixel;
  pData[nZ*xDim*yDim + (nY-1)*xDim + nX] = pixel;
  pData[nZ*xDim*yDim + nY*xDim + (nX+1)] = pixel;
  pData[nZ*xDim*yDim + nY*xDim + (nX-1)] = pixel;
}

void * generateFancy3DTexture(int xDim, int yDim, int zDim)
{
  int * texture = new int[xDim*yDim*zDim];
  memset(texture, 0, xDim*yDim*zDim*4);


  float t = 0;

  while (t < 50) {
    float x = sin((t + 1.4234)*1.9);
    float y = cos((t*2.5) - 10);
    float z = cos((t - 0.23123)*3)*sin(t + 0.5);

    setDot( texture,
            xDim, yDim, zDim,
            x*sin(t)*0.45 + 0.5,
            y*0.45 + 0.5,
            z*cos(t)*0.45 + 0.5,
            (unsigned char)(255.0*cos(t)),
            (unsigned char)(255.0*sin(t)),
            255,
            255);

    t += 0.001;
  }//while*/

  return texture;
}


int
main(int argc, char ** argv)
{
  @WIDGET@ window = So@Gui@::init( argv[0] );
  SoVolumeRendering::initClass();
  SoDB::setRealTimeInterval(SbTime(1.0/50.0));

  So@Gui@ExaminerViewer * ex1 = new So@Gui@ExaminerViewer( window );
  //  ex1->setBackgroundColor(SbColor(0.1f, 0.3f, 0.5f));

  SoSeparator *root = new SoSeparator;
  root->ref();

  SoPerspectiveCamera * myCamera = new SoPerspectiveCamera;
  myCamera->position = SbVec3f(0.0f, 0.0f, 5.0f);
  root->addChild(myCamera);
  root->addChild(new SoDirectionalLight);

  SoLightModel * lm = new SoLightModel;
  lm->model = SoLightModel::BASE_COLOR;
  root->addChild(lm);

  SoDrawStyle *drawStyle = new SoDrawStyle;
  drawStyle->style = SoDrawStyle::LINES;
  //   root->addChild(new SoTrackballManip);
  root->addChild(drawStyle);
  root->addChild(new SoCube);

  // Read the data (application supplied function)
  SbVec3s dim = SbVec3s(64, 64, 64);

  int *pData = (int *) generateFancy3DTexture(dim[0], dim[1], dim[2]);

  // Add VolumeData to scene graph
  SoVolumeData * pVolData = new SoVolumeData();
  pVolData->setVolumeData(dim, (unsigned char *)pData, SoVolumeRendering::RGBA);
  pVolData->setVolumeSize(SbBox3f(-1, -1, -1, 1, 1, 1));

  root->addChild(pVolData);

  // Add TransferFunction (color map) to scene graph
  SoTransferFunction *pTransFunc = new SoTransferFunction();
  root->addChild( pTransFunc );

  // Add VolumeRender to scene graph
  SoVolumeRender * pVolRend = new SoVolumeRender();
  root->addChild(pVolRend);
  pVolRend->numSlices = 64;

  myCamera->viewAll(root, ex1->getViewportRegion());
  ex1->setSceneGraph(root);

  ex1->show();
  So@Gui@::show( window );
  So@Gui@::mainLoop();
  delete ex1;

  root->unref();
  return 0;
}
